---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgresql-backup
  namespace: virtual-cv
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 3
      activeDeadlineSeconds: 300
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: backup
              image: postgres:16-alpine
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  apk add --no-cache rclone > /dev/null 2>&1

                  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                  BACKUP_FILE="/tmp/virtualcv-${TIMESTAMP}.sql.gz"

                  echo "=== Starting backup at $(date) ==="
                  pg_dump -h postgresql -U "$PGUSER" -d "$PGDATABASE" | gzip > "${BACKUP_FILE}"
                  echo "Dump complete: $(du -h ${BACKUP_FILE} | cut -f1)"

                  echo "Uploading to Google Drive..."
                  rclone --config /etc/rclone/rclone.conf copy "${BACKUP_FILE}" gdrive:/
                  echo "Upload complete."

                  # Retain last 3 backups, delete older ones
                  echo "Cleaning old backups..."
                  rclone --config /etc/rclone/rclone.conf lsf gdrive:/ --files-only | sort -r | tail -n +4 | while read -r f; do
                    echo "Deleting old backup: $f"
                    rclone --config /etc/rclone/rclone.conf deletefile "gdrive:/$f"
                  done

                  echo "=== Backup complete. Remote backups: ==="
                  rclone --config /etc/rclone/rclone.conf ls gdrive:/
              env:
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: postgresql-secret
                      key: POSTGRES_USER
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgresql-secret
                      key: POSTGRES_PASSWORD
                - name: PGDATABASE
                  valueFrom:
                    secretKeyRef:
                      name: postgresql-secret
                      key: POSTGRES_DB
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
              volumeMounts:
                - name: rclone-config
                  mountPath: /etc/rclone/rclone.conf
                  subPath: rclone.conf
                  readOnly: true
          volumes:
            - name: rclone-config
              secret:
                secretName: rclone-config
