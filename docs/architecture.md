# Architecture Overview

This document maps the structure, data flow, deployment topology, and design assessment of the virtual-cv monorepo.

---

## 1. Component Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        GitHub Pages                              │
│                  (fschmidt.github.io/virtual-cv)                │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              virtual-cv-ui (React + Vite)                │    │
│  │                                                          │    │
│  │  App.tsx ─────┬─── GraphNode.tsx                        │    │
│  │    │          ├─── InspectorPanel.tsx                    │    │
│  │    │          ├─── SearchDialog.tsx                      │    │
│  │    │          ├─── StandardCVView.tsx                    │    │
│  │    │          ├─── CreateNodeDialog.tsx                  │    │
│  │    │          ├─── ViewToggle.tsx                        │    │
│  │    │          └─── Toast / LoadingSkeleton / etc.        │    │
│  │    │                                                     │    │
│  │  Services:                                               │    │
│  │    cv.service.ts ── cv.mapper.ts ── content.service.ts  │    │
│  │    layout.service.ts                                     │    │
│  │    │                                                     │    │
│  │  API Layer:                                              │    │
│  │    generated.ts (Orval) → fetcher.ts → errors.ts        │    │
│  └──────────────────────────┬──────────────────────────────┘    │
│                              │ HTTPS (fetch)                     │
└──────────────────────────────┼───────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Hetzner Cloud (k3s)                           │
│                   (api.fschmidts.net)                            │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │           virtual-cv-api (Spring Boot)                   │    │
│  │                                                          │    │
│  │  CvController.java (REST endpoints)                      │    │
│  │    │                                                     │    │
│  │  CvNodeService.java (business logic)                     │    │
│  │    │                                                     │    │
│  │  CvNodeRepository.java (JPA + JPQL)                      │    │
│  │    │                                                     │    │
│  │  CvNode.java (entity, JSONB attributes)                  │    │
│  └──────────────────────────┬──────────────────────────────┘    │
│                              │ JDBC                              │
│  ┌──────────────────────────┴──────────────────────────────┐    │
│  │  PostgreSQL 16 (single cv_node table)                    │    │
│  │  Flyway migrations V1-V4                                 │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. End-to-End Data Flow

### Read Path (page load)

```
PostgreSQL (cv_node table, JSONB attributes)
  → Flyway migrations V1-V4 (schema setup)
  → CvNode.java (JPA entity)
  → CvNodeRepository.java (JPQL → CvNodeDto projection)
  → CvNodeService.java:30 (getAllNodes → CvDataDto wrapper)
  → CvController.java:27 (GET /cv)
  → OpenAPI spec (/v3/api-docs, auto-generated by springdoc)
  → Orval (orval.config.ts → generates TS client)
  → generated.ts:getAllNodes() (fetch call)
  → fetcher.ts:customFetch() (base URL, error handling, response shaping)
  → cv.service.ts:160 (getCVData → maps DTO to frontend types, caches)
  → cv.mapper.ts:113 (buildNodes → React Flow nodes with state computation)
  → App.tsx:161 (setNodes/setEdges)
  → GraphNode.tsx (renders node per state: detailed/quickview/dormant)
  → InspectorPanel.tsx (selected node content in side panel)
```

### Write Path (edit mode)

```
User action (edit/create/delete in InspectorPanel or CreateNodeDialog)
  → App.tsx callbacks (onSaveNode, onCreateNode, onDeleteNode)
  → cv.service.ts (updateNode/createNode/deleteNode → clears cache)
  → generated.ts (PUT/POST/DELETE via customFetch)
  → CvController.java (validates @Valid, delegates to service)
  → CvNodeService.java (entity manipulation + save)
  → CvNodeRepository.java (JPA persist/delete)
  → PostgreSQL
  → App.tsx re-fetches data (cvService.getCVData with cleared cache)
```

### Content Path (markdown content)

```
cv-content.md (static markdown file, bundled via Vite ?raw import)
  → content.service.ts:32 (parsed into ContentMap on module load)
  → App.tsx:129 (loaded into state as contentMap)
  → InspectorPanel.tsx (rendered via react-markdown)
```

Note: Content is currently file-based, not stored in the database. The `setNodeContent` function allows runtime updates but they are not persisted.

---

## 3. API Contract

### Actual Endpoints (from `CvController.java`)

| Method | Path | Handler | Request Body | Response |
|--------|------|---------|--------------|----------|
| GET | `/cv` | `getAllNodes()` | — | `CvDataDto` (nodes array) |
| GET | `/cv/nodes/{id}` | `getNode()` | — | `CvNodeDto` or 404 |
| GET | `/cv/nodes/{id}/children` | `getChildren()` | — | `CvNodeDto[]` |
| GET | `/cv/search?q=` | `search()` | — | `CvNodeDto[]` |
| POST | `/cv/nodes/profile` | `createProfile()` | `CreateProfileCommand` | 201 + `CvNodeDto` |
| POST | `/cv/nodes/category` | `createCategory()` | `CreateCategoryCommand` | 201 + `CvNodeDto` |
| POST | `/cv/nodes/item` | `createItem()` | `CreateItemCommand` | 201 + `CvNodeDto` |
| POST | `/cv/nodes/skill-group` | `createSkillGroup()` | `CreateSkillGroupCommand` | 201 + `CvNodeDto` |
| POST | `/cv/nodes/skill` | `createSkill()` | `CreateSkillCommand` | 201 + `CvNodeDto` |
| PUT | `/cv/nodes/{id}` | `updateNode()` | `UpdateNodeCommand` | `CvNodeDto` or 404 |
| DELETE | `/cv/nodes/{id}` | `deleteNode()` | — | 204 or 404 |
| GET | `/health` | `HealthController` | — | `{"status":"UP"}` |

### Documentation Discrepancies

- **`virtual-cv-api/README.md`**: All paths incorrectly prefixed with `/api` (e.g., `/api/cv` instead of `/cv`). The controller uses `@RequestMapping("/cv")`, not `/api/cv`.
- **`virtual-cv-api/README.md:61`**: Says "Soft delete node" — delete is actually **hard delete** with cascade since migration V4.
- **`CvController.java:94`**: Comment says `// Commands - Delete (soft)` — stale, should say "hard delete".

---

## 4. File Inventory

### Frontend (`virtual-cv-ui/src/`)

| File | Lines | Responsibility |
|------|-------|---------------|
| `App.tsx` | 408 | Application shell: state, routing, keyboard nav, dialog orchestration |
| `App.css` | 2,431 | All application styles (monolithic) |
| `main.tsx` | 10 | Entry point |
| `index.css` | ~20 | Base reset styles |
| **Components** | | |
| `InspectorPanel.tsx` | 696 | Side panel: node details, edit form, markdown rendering |
| `CreateNodeDialog.tsx` | 327 | Modal for creating new nodes |
| `SearchDialog.tsx` | 221 | Cmd+K search dialog |
| `GraphNode.tsx` | 152 | Unified node component (3 states) |
| `StandardCVView.tsx` | 143 | Alternative linear CV view |
| `FeatureTogglePopup.tsx` | 110 | Dev feature flag toggle UI |
| `DeleteConfirmDialog.tsx` | 104 | Delete confirmation modal |
| `ViewToggle.tsx` | 100 | Graph/CV/Edit mode selector |
| `Toast.tsx` | 99 | Toast notification system |
| `SectionIcon.tsx` | 66 | SVG icon renderer for category sections |
| `LoadingSkeleton.tsx` | 36 | Loading placeholder |
| **Services** | | |
| `cv.service.ts` | 228 | API wrapper, caching, type mapping |
| `cv.mapper.ts` | 219 | CVData → React Flow nodes/edges |
| `layout.service.ts` | 249 | Node size calculations |
| `content.service.ts` | 71 | Markdown content parsing |
| `index.ts` | 4 | Barrel export |
| **Types** | | |
| `cv.types.ts` | 89 | Domain types (CVNode, CVData, etc.) |
| `graph.types.ts` | 45 | UI types (NodeState, GraphNodeData) |
| `index.ts` | 2 | Barrel export |
| **Utils** | | |
| `feature-flags.ts` | 108 | Feature toggle system (localStorage + URL) |
| **API** | | |
| `generated.ts` | ~500 | Auto-generated API client (DO NOT EDIT) |
| `fetcher.ts` | 57 | Custom fetch wrapper with error handling |
| `errors.ts` | 68 | Typed error classes |
| **Data (potentially dead)** | | |
| `data/cv-content.ts` | 170 | Hardcoded CV data — **NOT IMPORTED, dead code** |
| `content/cv-content.md` | — | Markdown content for nodes (actively used) |

### Backend (`virtual-cv-api/src/main/java/de/fschmidt/virtualcv/`)

| File | Lines | Responsibility |
|------|-------|---------------|
| `VirtualCvApiApplication.java` | 13 | Spring Boot main class |
| **Controller** | | |
| `CvController.java` | 103 | REST endpoints (CRUD) |
| `HealthController.java` | 23 | Health check endpoint |
| **Service** | | |
| `CvNodeService.java` | 186 | Business logic, CRUD operations |
| **Repository** | | |
| `CvNodeRepository.java` | 64 | JPA repository with JPQL DTO queries |
| **Domain** | | |
| `CvNode.java` | 153 | JPA entity with JSONB attributes |
| **DTOs** | | |
| `CvDataDto.java` | 7 | Wrapper DTO (nodes list) |
| `CvNodeDto.java` | 16 | Node projection record |
| **Commands** | | |
| `CreateNodeCommand.java` | 16 | Sealed interface for create commands |
| `CreateProfileCommand.java` | 20 | Profile creation record |
| `CreateCategoryCommand.java` | 14 | Category creation record |
| `CreateItemCommand.java` | 20 | Item creation record |
| `CreateSkillGroupCommand.java` | 14 | Skill group creation record |
| `CreateSkillCommand.java` | 15 | Skill creation record |
| `UpdateNodeCommand.java` | 15 | Generic update record |
| **Config** | | |
| `SecurityConfig.java` | 41 | Security (all /cv/** permitAll, CSRF disabled) |
| `CorsConfig.java` | 30 | CORS (3 specific origins) |

### Infrastructure

| File | Purpose |
|------|---------|
| `k8s/api-deployment.yaml` | API deployment + service + ingress + secrets |
| `k8s/postgresql.yaml` | PostgreSQL deployment + PVC + secret |
| `k8s/cert-issuer.yaml` | Let's Encrypt cert-manager issuer |
| `k8s/README.md` | K8s deployment guide |
| `virtual-cv-api/Dockerfile` | Multi-stage Docker build (JDK 21 → JRE 21) |
| `virtual-cv-api/docker-compose.yml` | Local PostgreSQL |
| `.github/workflows/deploy.yml` | Frontend CI/CD → GitHub Pages |
| `.github/workflows/deploy-api.yml` | Backend CI/CD → Docker → K8s |

---

## 5. Configuration Surface Map

### Spring Profiles

| Profile | File | Key Settings |
|---------|------|-------------|
| (default) | `application.properties` | App name only |
| `local` | `application-local.properties` | Port 9823, local DB (5433), show SQL, all actuator |
| `prod` | `application-prod.properties` | Env-based DB creds, no SQL, health-only actuator |

### Environment Variables

| Variable | Where | Purpose |
|----------|-------|---------|
| `VITE_API_URL` | Frontend build | API base URL (default: `http://localhost:9823`) |
| `SPRING_PROFILES_ACTIVE` | Backend | Active Spring profile |
| `SPRING_DATASOURCE_URL` | K8s secret | Production DB connection |
| `SPRING_DATASOURCE_USERNAME` | K8s secret | Production DB user |
| `SPRING_DATASOURCE_PASSWORD` | K8s secret | Production DB password |

### Feature Flags

| Flag | Key | Toggle | Purpose |
|------|-----|--------|---------|
| Edit Mode | `editMode` | Ctrl+Shift+D | Enables CRUD UI in graph |

Storage: `localStorage` key `virtual-cv-features`. Override: `?features=editMode` URL param.

---

## 6. CI/CD Pipeline Map

### Frontend (`deploy.yml`)

```
Trigger: push to main (any file) OR manual dispatch
Steps: checkout → setup Node 22 → npm ci → npm run build → upload → deploy to Pages
Missing: npm run lint (NOT run), no tests
```

### Backend (`deploy-api.yml`)

```
Trigger: push to main (paths: virtual-cv-api/**, .github/workflows/deploy-api.yml) OR manual
Steps: checkout → Docker buildx → login to GHCR → build+push image → kubectl rollout restart
Missing: ./gradlew test (NOT run), ./gradlew build (NOT run — Docker handles it but skips tests with -x test)
```

### Deployment Topology

```
Developer → git push main
  ├─ deploy.yml → GitHub Pages (frontend)
  └─ deploy-api.yml → GHCR → K8s rollout restart (backend)
                                ├─ virtual-cv-api (1 replica, 256-512Mi)
                                └─ postgresql (1 replica, 128-256Mi, 1Gi PVC)
```

### Test Gates: **NONE**

Both pipelines deploy regardless of test/lint results. The Dockerfile explicitly skips tests: `./gradlew build -x test`.

---

## 7. Database Schema

Single table `cv_node` with JSONB `attributes` column for type-specific data:

```sql
CREATE TABLE cv_node (
    id          VARCHAR(50) PRIMARY KEY,
    type        VARCHAR(20) NOT NULL,  -- PROFILE, CATEGORY, ITEM, SKILL_GROUP, SKILL
    parent_id   VARCHAR(50) REFERENCES cv_node(id),
    label       VARCHAR(255) NOT NULL,
    description TEXT,
    attributes  JSONB,                 -- Type-specific fields
    position_x  INTEGER,
    position_y  INTEGER,
    created_at  TIMESTAMP NOT NULL,
    updated_at  TIMESTAMP NOT NULL
);
```

### Migration History

| Version | Description |
|---------|-------------|
| V1 | Create cv_node table |
| V2 | Add audit columns and soft delete (deleted_at) |
| V3 | Seed initial CV data |
| V4 | Remove soft delete (drop deleted_at column) |

---

## Architecture Assessment

_Added by Agent 2: Architecture Analyst_

### Strengths

1. **Clean backend layering.** Controller → Service → Repository is strictly followed. `CvController.java` contains zero business logic; it delegates entirely to `CvNodeService.java` and only handles HTTP concerns (status codes, URI creation, request validation). The service owns all domain logic including recursive delete, attribute merging, and DTO mapping.

2. **Sealed interface for create commands.** The `CreateNodeCommand` sealed interface (`virtual-cv-api/.../command/CreateNodeCommand.java:3`) with five permitted implementations enables exhaustive pattern matching in `CvNodeService.java:68-100`. The compiler enforces that all node types are handled — adding a new node type produces a compile error everywhere it matters.

3. **Generated API client as a contract boundary.** Using Orval to generate `generated.ts` from the OpenAPI spec means the frontend-backend contract is mechanically enforced. The generated code is marked DO NOT EDIT and imported as-is, eliminating hand-written API types as a source of drift.

4. **Discriminated union type system on the frontend.** The `CVNode` union type (`cv.types.ts`) uses `type` as a discriminator, and `cv.service.ts:64-111` maps each API node to the correct frontend type via a switch. The mapper is the single point where untyped JSONB attributes are structured into typed domain objects.

5. **Pragmatic single-table design.** The JSONB `attributes` column avoids a proliferation of join tables for what is fundamentally a small, read-heavy dataset. The Flyway migration history is clean: V1 (create), V2 (audit + soft delete), V3 (seed), V4 (drop soft delete) — showing willingness to simplify.

6. **Progressive disclosure architecture.** The three-state system (detailed/quickview/dormant) with `computeNodeState` (`cv.mapper.ts:26-51`) cleanly separates visual state computation from rendering. The inspector-mode pattern keeps content in the side panel rather than on canvas nodes.

7. **Feature flag system is well-isolated.** `feature-flags.ts` uses localStorage with URL parameter override — lightweight, zero-dependency, appropriate for a portfolio project.

8. **CORS configuration is explicit and restrictive.** `CorsConfig.java:17-21` whitelists three specific origins rather than using `*`.

---

### Frontend Concerns

**F1. App.tsx is a god component (moderate severity).**
`virtual-cv-ui/src/App.tsx` (408 lines) contains 10 `useState` hooks (lines 76-85), 2 `useRef` hooks (lines 106-107), 8+ `useCallback` hooks, 7 `useEffect` hooks, and 1 `useMemo`. It orchestrates data loading, graph rebuilding, keyboard shortcuts, URL hash sync, node CRUD operations, drag handling, dialog state, and view mode switching.

Three concerns could be separated:
- **Data management** (lines 229-289): each CRUD callback follows the same pattern: call service → re-fetch → update state → toast. Duplicated across `onSaveNode`, `onDeleteNode`, `onCreateNode`, `onPublishNode`.
- **Dialog orchestration**: the Escape handler at lines 181-209 has a four-level priority chain.
- **Graph interaction**: the double `setTimeout` at lines 168-175 is a brittle workaround for CSS transition timing.

**F2. Manual cache with no TTL (moderate severity).**
`virtual-cv-ui/src/services/cv.service.ts:153` stores `cachedData: CVData | null` on a singleton. Cache is cleared on write ops but never expires. If backend data changes externally, the frontend serves stale data indefinitely until a write or page reload. The cache-then-network pattern is implicit, not enforced.

**F3. Unsafe type cast in `customFetch` (high severity for correctness).**
`virtual-cv-ui/src/api/fetcher.ts:50,54` perform `as T` casts on `{ data, status, headers }`. The return type lies: callers think they get `T` (the DTO), but actually get `{ data: T, status, headers }`. Works only because all callers access `.data` — but completely defeats TypeScript's type safety.

**F4. Double casts to bridge generated type mismatch (moderate severity).**
- `virtual-cv-ui/src/App.tsx:279`: `{ isDraft: !publish } as unknown as UpdateNodeCommand['attributes']`
- Root cause: `UpdateNodeCommandAttributes` in `generated.ts:8` is typed as `{[key: string]: { [key: string]: unknown }}` (nested), but backend accepts flat `{ isDraft: true }`. OpenAPI spec doesn't accurately represent `Map<String, Object>`.

**F5. Non-null assertions assume API completeness (low severity).**
`virtual-cv-ui/src/services/cv.service.ts:53` uses `dto.type!`, line 57 uses `dto.id!`. All `CvNodeDto` fields are optional in the generated type. Practically safe but masks potential issues if the API contract changes.

**F6. `Record<string, unknown>` casts in CreateNodeDialog (moderate severity).**
`virtual-cv-ui/src/components/CreateNodeDialog.tsx:131-144` uses 7 separate `(command as Record<string, unknown>)` casts to dynamically add type-specific fields. Sidesteps the discriminated union type system.

**F7. Monolithic CSS with hardcoded theme values (moderate severity for extensibility).**
`virtual-cv-ui/src/App.css` is 2,431 lines with no CSS custom properties for theme colors. Background `#0d0d14` appears ~4 times, node background `#1a1a2e` ~20 times, accent purple `#667eea` ~30 times. Adding a light theme toggle (`backlog.md:62`) would require replacing 100+ hardcoded values.

**F8. `GraphNodeData` index signature weakens type safety (low severity).**
`virtual-cv-ui/src/types/graph.types.ts:38` includes `[key: string]: unknown` for React Flow compatibility, meaning typos in property names won't produce errors.

---

### Backend Concerns

**B1. No authentication on write endpoints (conscious choice, documented here).**
`virtual-cv-api/.../config/SecurityConfig.java:20` permits all `/cv/**`. Combined with CSRF disabled (line 17), any HTTP client can create, modify, or delete all CV data. CORS whitelist provides browser-only protection. For a personal portfolio with Flyway recovery, this is pragmatic but should be a documented decision.

**B2. Stale comment on delete endpoint.**
`virtual-cv-api/.../controller/CvController.java:94` says `// Commands - Delete (soft)` but delete is hard delete with cascade since V4 migration.

**B3. Recursive delete without depth protection (low severity).**
`virtual-cv-api/.../service/CvNodeService.java:158-166` issues N+1 queries (one `findByParentId` per node). For CV data volume (tens of nodes, max depth ~3-4), this is negligible. A CTE-based single query would be more efficient.

**B4. Sealed interface + 5 create commands: justified ceremony.**
~100 lines of record definitions buy: type-specific `@NotBlank` validation, exhaustive pattern matching with compiler enforcement, and type-specific REST endpoints with clear OpenAPI docs. A single generic command would lose validation precision. The trade-off is proportionate.

**B5. JSONB attributes lose type information at persistence boundary (design trade-off).**
`CvNode.java:38` uses `Map<String, Object>`. No compile-time guarantee a PROFILE node has `name`/`title` in attributes. Contract enforced only by service during creation and by frontend mapper during reading. `UpdateNodeCommand.java:12` accepts `Map<String, Object>` with no key/value validation — service does blind `putAll` merge.

**B6. `UpdateNodeCommand` minimal validation (low severity).**
Only `@NotBlank` on `id`. No validation that at least one field is non-null — a body of `{ "id": "x" }` succeeds as a no-op write.

---

### Vision vs. Reality Summary

#### Planned but Not Built

| Feature | Roadmap Phase | Status |
|---------|--------------|--------|
| CLI client | Phase 4 | Parking lot in backlog |
| Edge entity (from, to, type, label) | Phase 2 | Dropped — edges derived from `parentId` |
| Media / S3 object storage | Phase 2 | Not implemented; images use external URLs |
| Guided tour / onboarding | Phase 1 | Backlog future feature |
| Light/dark theme toggle | Phase 1 | Backlog, blocked by hardcoded CSS (F7) |
| Breadcrumb navigation | Phase 1 | Partial — exists in InspectorPanel, not on canvas |
| View / Scene entry points | Phase 2 | Not implemented |
| Export formats (PDF, MD, JSON) | Phase 5 | Backlog items |
| Structured logging / metrics | Phase 5 | Not implemented beyond health endpoint |
| E2E tests (Playwright) | Phase 5 | Not implemented |

#### Built but Not Planned

| Feature | Location | Notes |
|---------|----------|-------|
| Feature flag system | `feature-flags.ts` | localStorage + URL param toggle via Ctrl+Shift+D |
| Drag-to-position nodes | `App.tsx:292-317`, `cv.mapper.ts:131-154` | Position persisted to backend |
| Deep linking via URL hash | `App.tsx:41-60` | `#node=<id>` with history integration |
| Toast notifications | `Toast.tsx` | Context-based success/error/info |
| Standard CV view | `StandardCVView.tsx` | Traditional linear CV alternative |
| Draft/publish workflow | `isDraft` attribute | Visual styling with dashed border, amber |
| Mobile bottom sheet | `App.css:1787-2015` | Responsive inspector panel |

#### Changed from Plan

| Aspect | Original Plan | Actual |
|--------|---------------|--------|
| **Authentication** | JWT or basic auth (Phase 2) | None — all `permitAll()` |
| **Persistence** | Node + Edge entities | Single `cv_node` table, edges from `parentId` |
| **Admin** | Separate admin interface (Phase 3) | Integrated edit mode with feature flag |
| **Delete** | Soft delete (V2 migration) | Hard delete with cascade (V4) |
| **Content** | Stored in DB with nodes | Split: markdown in static file, structured data in DB |
| **Deployment** | Docker Compose all-in-one (Phase 6) | Frontend on GitHub Pages, backend on k3s |
